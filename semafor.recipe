from calibre.web.feeds.news import BasicNewsRecipe
from calibre.utils.date import parse_date
from datetime import datetime

class Semafor(BasicNewsRecipe):
    title = 'Semafor'
    description = 'Global news and insights with transparent sourcing'
    language = 'en'
    __author__ = 'Semafor'
    oldest_article = 2  # days
    max_articles_per_feed = 50
    no_stylesheets = True
    remove_javascript = True
    use_embedded_content = False
    encoding = 'utf-8'
    auto_cleanup = True
    timeout = 20
    timefmt = '[%Y-%m-%d]'
    
    feeds = [
        ('Latest News', 'https://www.semafor.com/rss/news'),
        ('Flagship', 'https://www.semafor.com/rss/flagship'),
        ('Business', 'https://www.semafor.com/rss/business'),
        ('Technology', 'https://www.semafor.com/rss/technology'),
        ('Politics', 'https://www.semafor.com/rss/politics'),
        ('World', 'https://www.semafor.com/rss/world')
    ]
    
    keep_only_tags = [
        dict(name='article', attrs={'class': 'article'}),
        dict(name='div', attrs={'class': 'article-body'}),
    ]
    
    remove_tags = [
        dict(name='div', attrs={'class': 'article-header__meta'}),
        dict(name='div', attrs={'class': 'article-share'}),
        dict(name='div', attrs={'class': 'newsletter-signup'}),
        dict(name='div', attrs={'class': 'article-recirc'}),
        dict(name='div', attrs={'class': 'article-comments'}),
        dict(name='aside'),
        dict(name='figure', attrs={'class': 'article-image--full'}),
        dict(name='script'),
        dict(name='style'),
        dict(name='iframe'),
        dict(name='svg'),
    ]
    
    extra_css = '''
        h1 { font-size: 1.8em; margin-bottom: 0.5em; }
        .article-body__chatter { 
            font-size: 1.2em; color: #555; font-style: italic; 
            margin-bottom: 1em; 
        }
        .article-body__content p { margin: 0.8em 0; line-height: 1.6; }
        .article-body__content h2 { 
            font-size: 1.4em; margin: 1.5em 0 0.8em 0;
            border-bottom: 1px solid #ddd; padding-bottom: 0.3em;
        }
        .semafor-sources { 
            background-color: #f5f5f5; 
            padding: 1em; 
            margin: 1.5em 0;
            border-left: 3px solid #ccc;
        }
        .semafor-sources h3 { margin-top: 0; }
    '''
    
    def preprocess_html(self, soup):
        # Clean up the article structure
        header = soup.find('div', class_='article-header')
        if header:
            # Move headline to beginning of article
            headline = header.find('h1')
            if headline:
                article_body = soup.find('div', class_='article-body')
                if article_body:
                    article_body.insert(0, headline)
            
            # Move chatter/subhead below headline
            chatter = header.find('div', class_='article-header__chatter')
            if chatter:
                article_body = soup.find('div', class_='article-body')
                if article_body:
                    article_body.insert(1, chatter)
                    chatter['class'] = 'article-body__chatter'
        
        # Clean up sources section
        sources = soup.find('div', class_='article-sources')
        if sources:
            sources['class'] = 'semafor-sources'
            sources_h3 = sources.find('h3')
            if not sources_h3:
                h3 = soup.new_tag('h3')
                h3.string = 'Sources'
                sources.insert(0, h3)
        
        return soup
    
    def parse_feeds(self):
        feeds = BasicNewsRecipe.parse_feeds(self)
        for feed in feeds:
            for article in feed.articles:
                # Clean up dates (Semafor sometimes includes timezone info)
                if article.date:
                    if 'T' in article.date:
                        article.date = article.date.split('T')[0]
                    article.date = parse_date(article.date)
        return feeds